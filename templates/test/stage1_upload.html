{% extends "base.html" %}

{% block title %}Test Stage 1: Video Upload - Viral Clips{% endblock %}

{% block content %}
<div class="min-h-screen bg-gray-900 py-12 px-4 sm:px-6 lg:px-8">
    <div class="max-w-4xl mx-auto">
        <!-- Header -->
        <div class="mb-8">
            <h1 class="text-3xl font-bold text-white mb-2">üß™ Stage 1 Test: Media Upload & Audio Extraction</h1>
            <p class="text-gray-400">Upload media files (up to 5GB) to S3. Video files will have audio automatically extracted.</p>
            <div class="mt-4 bg-blue-900/20 border border-blue-700/50 rounded-lg p-4">
                <p class="text-blue-300 text-sm">
                    <strong>Stage 1 Pipeline:</strong> Upload ‚Üí Store in S3 ‚Üí Extract Audio (if video) ‚Üí Store Audio in S3
                </p>
            </div>
            <!-- TUS Alternative Link -->
            <div class="mt-4 bg-purple-900/20 border border-purple-700/50 rounded-lg p-4">
                <p class="text-purple-300 text-sm">
                    <strong>Try TUS Resumable Uploads:</strong> 
                    <a href="{% url 'test-stage1-tus' %}" class="text-purple-400 hover:text-purple-300 underline">
                        Test Uppy + TUS ‚Üí
                    </a>
                    <span class="text-purple-400/70"> (pause/resume, survives page reload)</span>
                </p>
            </div>
        </div>

        <!-- Upload Section -->
        <div class="bg-gray-800 rounded-lg shadow-xl p-8 border border-gray-700">
            <!-- File Picker -->
            <div class="mb-6">
                <label class="block text-sm font-medium text-gray-300 mb-2">
                    Select Media File
                </label>
                <div class="mt-1 flex justify-center px-6 pt-5 pb-6 border-2 border-gray-600 border-dashed rounded-lg hover:border-primary-500 transition-colors cursor-pointer"
                     id="drop-zone">
                    <div class="space-y-1 text-center">
                        <svg class="mx-auto h-12 w-12 text-gray-400" stroke="currentColor" fill="none" viewBox="0 0 48 48">
                            <path d="M28 8H12a4 4 0 00-4 4v20m32-12v8m0 0v8a4 4 0 01-4 4H12a4 4 0 01-4-4v-4m32-4l-3.172-3.172a4 4 0 00-5.656 0L28 28M8 32l9.172-9.172a4 4 0 015.656 0L28 28m0 0l4 4m4-24h8m-4-4v8m-12 4h.02" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" />
                        </svg>
                        <div class="flex text-sm text-gray-400">
                            <label for="file-upload" class="relative cursor-pointer rounded-md font-medium text-primary-400 hover:text-primary-300 focus-within:outline-none">
                                <span>Upload a file</span>
                                <input id="file-upload" name="file-upload" type="file" class="sr-only" accept="video/*,audio/*">
                            </label>
                            <p class="pl-1">or drag and drop</p>
                        </div>
                        <p class="text-xs text-gray-500">
                            Video or audio files up to 5GB
                        </p>
                    </div>
                </div>
                <div id="file-info" class="mt-4 hidden">
                    <div class="bg-gray-700 rounded-lg p-4">
                        <div class="flex items-center justify-between">
                            <div class="flex items-center space-x-3">
                                <svg class="h-8 w-8 text-primary-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 10l4.553-2.276A1 1 0 0121 8.618v6.764a1 1 0 01-1.447.894L15 14M5 18h8a2 2 0 002-2V8a2 2 0 00-2-2H5a2 2 0 00-2 2v8a2 2 0 002 2z" />
                                </svg>
                                <div>
                                    <p class="text-sm font-medium text-white" id="file-name"></p>
                                    <p class="text-xs text-gray-400" id="file-size"></p>
                                </div>
                            </div>
                            <button id="remove-file" class="text-red-400 hover:text-red-300">
                                <svg class="h-5 w-5" fill="currentColor" viewBox="0 0 20 20">
                                    <path fill-rule="evenodd" d="M4.293 4.293a1 1 0 011.414 0L10 8.586l4.293-4.293a1 1 0 111.414 1.414L11.414 10l4.293 4.293a1 1 0 01-1.414 1.414L10 11.414l-4.293 4.293a1 1 0 01-1.414-1.414L8.586 10 4.293 5.707a1 1 0 010-1.414z" clip-rule="evenodd"></path>
                                </svg>
                            </button>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Upload Info -->
            <div id="upload-info" class="mb-6 hidden">
                <div class="bg-gray-700 rounded-lg p-4 space-y-3">
                    <div class="flex justify-between text-sm">
                        <span class="text-gray-400">File Size:</span>
                        <span id="file-size-display" class="text-white font-medium"></span>
                    </div>
                    <div class="flex justify-between text-sm">
                        <span class="text-gray-400">Part Size:</span>
                        <span id="part-size-display" class="text-white font-medium"></span>
                    </div>
                    <div class="flex justify-between text-sm">
                        <span class="text-gray-400">Total Parts:</span>
                        <span id="total-parts-display" class="text-white font-medium"></span>
                    </div>
                </div>
            </div>

            <!-- Upload Button -->
            <div class="mb-6">
                <button id="upload-btn" disabled
                        class="w-full bg-primary-600 text-white px-6 py-3 rounded-lg font-medium hover:bg-primary-500 transition-colors disabled:opacity-50 disabled:cursor-not-allowed">
                    Start Upload
                </button>
            </div>

            <!-- Progress Section -->
            <div id="progress-section" class="hidden mb-6">
                <div class="space-y-4">
                    <!-- Overall Progress -->
                    <div class="space-y-2">
                        <div class="flex justify-between text-sm">
                            <span class="text-gray-300 font-medium" id="progress-status">Preparing upload...</span>
                            <span class="text-primary-400 font-bold text-lg" id="progress-percent">0%</span>
                        </div>
                        <div class="w-full bg-gray-700 rounded-full h-4 overflow-hidden shadow-inner">
                            <div id="progress-bar" class="bg-gradient-to-r from-primary-600 via-primary-500 to-primary-400 h-4 rounded-full transition-all duration-300 shadow-lg" style="width: 0%"></div>
                        </div>
                        <div class="flex justify-between text-xs text-gray-400">
                            <span id="upload-speed" class="font-medium">‚ö° -</span>
                            <span id="time-remaining" class="font-medium">‚è±Ô∏è -</span>
                        </div>
                    </div>

                    <!-- Active Parts Progress -->
                    <div class="mt-4">
                        <div class="flex justify-between items-center mb-3">
                            <span class="text-sm text-gray-300 font-medium">Active Part Uploads</span>
                            <span class="text-xs text-gray-400" id="parts-counter">0 / 0 completed</span>
                        </div>
                        <div id="active-parts-container" class="space-y-2">
                            <!-- Active part progress bars will be shown here -->
                            <div class="text-center text-sm text-gray-500 py-4">
                                No active uploads
                            </div>
                        </div>
                    </div>

                    <!-- Upload Stats -->
                    <div class="grid grid-cols-3 gap-3 mt-3">
                        <div class="bg-gray-700/50 rounded px-3 py-2">
                            <div class="text-xs text-gray-400">Uploaded</div>
                            <div class="text-sm text-white font-medium" id="uploaded-size">0 MB</div>
                        </div>
                        <div class="bg-gray-700/50 rounded px-3 py-2">
                            <div class="text-xs text-gray-400">Active</div>
                            <div class="text-sm text-primary-400 font-medium" id="active-parts">0</div>
                        </div>
                        <div class="bg-gray-700/50 rounded px-3 py-2">
                            <div class="text-xs text-gray-400">Avg Speed</div>
                            <div class="text-sm text-green-400 font-medium" id="avg-speed">- MB/s</div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Audio Extraction Section -->
            <div id="extraction-section" class="hidden mb-6">
                <div class="bg-blue-900/20 border border-blue-700/50 rounded-lg p-6">
                    <div class="flex items-start space-x-3">
                        <svg class="h-6 w-6 text-blue-400 mt-0.5 animate-spin" fill="none" stroke="currentColor" viewBox="0 0 24 24" id="extraction-spinner">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15" />
                        </svg>
                        <div class="flex-1">
                            <h3 class="text-lg font-medium text-blue-300 mb-2" id="extraction-title">Extracting Audio...</h3>
                            <p class="text-sm text-gray-300" id="extraction-status">Downloading video and extracting audio track using ffmpeg...</p>
                            <div class="mt-3 w-full bg-gray-700 rounded-full h-2 overflow-hidden">
                                <div id="extraction-progress-bar" class="bg-gradient-to-r from-blue-600 to-blue-400 h-2 rounded-full transition-all duration-500" style="width: 30%"></div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Result Section -->
            <div id="result-section" class="hidden">
                <div class="bg-green-900/20 border border-green-700/50 rounded-lg p-6">
                    <div class="flex items-start space-x-3">
                        <svg class="h-6 w-6 text-green-400 mt-0.5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z" />
                        </svg>
                        <div class="flex-1">
                            <h3 class="text-lg font-medium text-green-300 mb-2">Stage 1 Complete!</h3>
                            <div class="space-y-3">
                                <div>
                                    <p class="text-xs text-gray-400 mb-1">Job ID:</p>
                                    <p class="text-sm text-white font-mono bg-gray-700 px-3 py-2 rounded" id="result-job-id"></p>
                                </div>
                                <div>
                                    <p class="text-xs text-gray-400 mb-1">Original Media URL:</p>
                                    <a id="result-url" href="#" target="_blank" 
                                       class="text-sm text-primary-400 hover:text-primary-300 break-all underline font-mono bg-gray-700 px-3 py-2 rounded block">
                                    </a>
                                </div>
                                <div id="audio-url-section" class="hidden">
                                    <p class="text-xs text-gray-400 mb-1">Extracted Audio URL:</p>
                                    <a id="result-audio-url" href="#" target="_blank" 
                                       class="text-sm text-green-400 hover:text-green-300 break-all underline font-mono bg-gray-700 px-3 py-2 rounded block">
                                    </a>
                                </div>
                                <div>
                                    <p class="text-xs text-gray-400 mb-1">Processing Details:</p>
                                    <div class="text-sm text-gray-300 bg-gray-700 px-3 py-2 rounded space-y-1">
                                        <p>File Type: <span id="result-file-type" class="font-medium"></span></p>
                                        <p>Upload Time: <span id="result-upload-time" class="font-medium"></span></p>
                                        <p id="extraction-time-row" class="hidden">Audio Extraction: <span id="result-extraction-time" class="font-medium"></span></p>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Error Section -->
            <div id="error-section" class="hidden">
                <div class="bg-red-900/20 border border-red-700/50 rounded-lg p-6">
                    <div class="flex items-start space-x-3">
                        <svg class="h-6 w-6 text-red-400 mt-0.5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4m0 4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z" />
                        </svg>
                        <div class="flex-1">
                            <h3 class="text-lg font-medium text-red-300 mb-2">Upload Failed</h3>
                            <p class="text-sm text-gray-300" id="error-message"></p>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Navigation -->
        <div class="mt-6 flex justify-end">
            <a href="{% url 'test-stage2' %}" class="text-purple-400 hover:text-purple-300 transition-colors">
                Stage 2: Transcription ‚Üí
            </a>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_scripts %}
<script>
    // Upload state
    let selectedFile = null;
    let activeUploads = []; // Track active parallel uploads
    let uploadState = {
        uploadId: null,
        s3Key: null,
        jobId: null,
        parts: [],
        uploadedParts: 0,
        totalParts: 0,
        uploadedBytes: 0,
        totalBytes: 0,
        startTime: null,
        isUploading: false
    };

    // DOM elements
    const fileInput = document.getElementById('file-upload');
    const dropZone = document.getElementById('drop-zone');
    const fileInfo = document.getElementById('file-info');
    const uploadBtn = document.getElementById('upload-btn');
    const progressSection = document.getElementById('progress-section');
    const resultSection = document.getElementById('result-section');
    const errorSection = document.getElementById('error-section');
    const removeFileBtn = document.getElementById('remove-file');

    // File selection
    fileInput.addEventListener('change', handleFileSelect);
    removeFileBtn.addEventListener('click', clearFile);
    uploadBtn.addEventListener('click', startUpload);

    // Drag and drop
    dropZone.addEventListener('dragover', (e) => {
        e.preventDefault();
        dropZone.classList.add('border-primary-500', 'bg-gray-700');
    });

    dropZone.addEventListener('dragleave', () => {
        dropZone.classList.remove('border-primary-500', 'bg-gray-700');
    });

    dropZone.addEventListener('drop', (e) => {
        e.preventDefault();
        dropZone.classList.remove('border-primary-500', 'bg-gray-700');
        const files = e.dataTransfer.files;
        if (files.length > 0) {
            handleFile(files[0]);
        }
    });

    function handleFileSelect(e) {
        const file = e.target.files[0];
        if (file) {
            handleFile(file);
        }
    }

    function handleFile(file) {
        // Validate file type
        const validTypes = ['video/', 'audio/'];
        if (!validTypes.some(type => file.type.startsWith(type))) {
            showToast('Please select a video or audio file', 'error');
            return;
        }

        // Validate file size (5GB limit)
        const maxSize = 5 * 1024 * 1024 * 1024; // 5GB
        if (file.size > maxSize) {
            showToast('File too large. Maximum size is 5GB', 'error');
            return;
        }

        selectedFile = file;
        displayFileInfo(file);
        uploadBtn.disabled = false;
    }

    function calculateOptimalPartSize(fileSize) {
        // Calculate optimal part size based on file size
        // AWS S3 limits: min 5MB, max 10,000 parts
        const MB = 1024 * 1024;
        const minPartSize = 5 * MB;  // 5MB minimum
        const maxParts = 10000;
        
        let partSize;
        
        if (fileSize < 100 * MB) {
            // Small files (< 100MB): single part (no multipart)
            partSize = fileSize;
        } else if (fileSize < 500 * MB) {
            // Medium files (100MB - 500MB): 10MB parts
            partSize = 10 * MB;
        } else if (fileSize < 1 * 1024 * MB) {
            // Large files (500MB - 1GB): 20MB parts
            partSize = 20 * MB;
        } else if (fileSize < 2 * 1024 * MB) {
            // Very large files (1GB - 2GB): 50MB parts
            partSize = 50 * MB;
        } else {
            // Huge files (2GB+): 100MB parts
            partSize = 100 * MB;
        }
        
        // Ensure we don't exceed max parts limit
        const numParts = Math.ceil(fileSize / partSize);
        if (numParts > maxParts) {
            partSize = Math.ceil(fileSize / maxParts);
        }
        
        // Ensure minimum part size
        partSize = Math.max(partSize, minPartSize);
        
        return partSize;
    }

    function displayFileInfo(file) {
        document.getElementById('file-name').textContent = file.name;
        document.getElementById('file-size').textContent = formatBytes(file.size);
        fileInfo.classList.remove('hidden');
        dropZone.classList.add('hidden');
        
        // Calculate and display upload info
        const partSize = calculateOptimalPartSize(file.size);
        const numParts = Math.ceil(file.size / partSize);
        
        document.getElementById('file-size-display').textContent = formatBytes(file.size);
        document.getElementById('part-size-display').textContent = formatBytes(partSize);
        document.getElementById('total-parts-display').textContent = numParts;
        document.getElementById('upload-info').classList.remove('hidden');
    }

    function clearFile() {
        selectedFile = null;
        fileInput.value = '';
        fileInfo.classList.add('hidden');
        dropZone.classList.remove('hidden');
        uploadBtn.disabled = true;
        hideAllSections();
    }

    function hideAllSections() {
        progressSection.classList.add('hidden');
        resultSection.classList.add('hidden');
        errorSection.classList.add('hidden');
        document.getElementById('upload-info').classList.add('hidden');
        document.getElementById('extraction-section').classList.add('hidden');
    }

    async function startUpload() {
        if (!selectedFile || uploadState.isUploading) return;

        // Reset state
        hideAllSections();
        activeUploads = []; // Clear active uploads
        uploadState = {
            uploadId: null,
            s3Key: null,
            jobId: null,
            parts: [],
            uploadedParts: 0,
            totalParts: 0,
            uploadedBytes: 0,
            totalBytes: selectedFile.size,
            startTime: Date.now(),
            isUploading: true
        };

        // Show progress
        progressSection.classList.remove('hidden');
        uploadBtn.disabled = true;
        updateProgress(0, 'Initiating upload...');

        // Calculate optimal part size
        const partSize = calculateOptimalPartSize(selectedFile.size);
        const numParts = Math.ceil(selectedFile.size / partSize);
        
        // Initialize parts grid
        initializePartsGrid(numParts);

        try {
            // Step 1: Initiate multipart upload
            
            const initResponse = await fetch('/api/upload/multipart/initiate/', {
                method: 'POST',
                headers: getAuthHeaders(),
                body: JSON.stringify({
                    filename: selectedFile.name,
                    content_type: selectedFile.type,
                    file_size: selectedFile.size,
                    part_size: partSize
                })
            });

            const initData = await initResponse.json();
            if (!initData.success) {
                throw new Error(initData.error || 'Failed to initiate upload');
            }

            uploadState.uploadId = initData.upload_id;
            uploadState.s3Key = initData.s3_key;
            uploadState.jobId = initData.job_id;
            uploadState.totalParts = initData.num_parts;

            updateProgress(5, `Uploading ${uploadState.totalParts} parts...`);

            // Step 2: Upload parts in parallel (with concurrency limit)
            const concurrency = 6; // Upload 6 parts simultaneously for maximum bandwidth
            await uploadPartsInParallel(partSize, concurrency);

            // Step 3: Complete multipart upload
            updateProgress(95, 'Finalizing upload...');
            
            // Sort parts by part number (S3 requires them in order)
            const sortedParts = uploadState.parts.sort((a, b) => a.PartNumber - b.PartNumber);
            
            // Verify all parts were uploaded
            console.log(`Completing upload: ${sortedParts.length} parts uploaded out of ${uploadState.totalParts} expected`);
            if (sortedParts.length !== uploadState.totalParts) {
                throw new Error(`Upload incomplete: only ${sortedParts.length} of ${uploadState.totalParts} parts uploaded`);
            }
            
            const completeResponse = await fetch('/api/upload/multipart/complete/', {
                method: 'POST',
                headers: getAuthHeaders(),
                body: JSON.stringify({
                    upload_id: uploadState.uploadId,
                    s3_key: uploadState.s3Key,
                    parts: sortedParts
                })
            });

            const completeData = await completeResponse.json();
            if (!completeData.success) {
                throw new Error(completeData.error || 'Failed to complete upload');
            }

            updateProgress(100, 'Upload complete!');
            
            // Display result (and extract audio if video)
            await showResult(completeData);

        } catch (error) {
            console.error('Upload error:', error);
            showError(error.message);
            
            // Try to abort the upload
            if (uploadState.uploadId && uploadState.s3Key) {
                try {
                    await fetch('/api/upload/multipart/abort/', {
                        method: 'POST',
                        headers: getAuthHeaders(),
                        body: JSON.stringify({
                            upload_id: uploadState.uploadId,
                            s3_key: uploadState.s3Key
                        })
                    });
                } catch (abortError) {
                    console.error('Failed to abort upload:', abortError);
                }
            }
        } finally {
            uploadState.isUploading = false;
            uploadBtn.disabled = false;
        }
    }

    async function uploadPartsInParallel(partSize, concurrency) {
        // Reset active uploads tracking
        activeUploads = [];
        
        // Create array of all part numbers to upload
        const allParts = [];
        for (let partNumber = 1; partNumber <= uploadState.totalParts; partNumber++) {
            allParts.push(partNumber);
        }

        // Upload parts with concurrency control
        let index = 0;
        const uploadPromises = [];

        async function uploadNext() {
            while (index < allParts.length) {
                const partNumber = allParts[index++];
                
                // Add to active tracking
                const dummyPromise = Promise.resolve();
                activeUploads.push(dummyPromise);
                
                try {
                    await uploadPart(partNumber, partSize);
                } finally {
                    // Remove from active tracking
                    const idx = activeUploads.indexOf(dummyPromise);
                    if (idx > -1) activeUploads.splice(idx, 1);
                }
            }
        }

        // Start concurrent workers
        for (let i = 0; i < concurrency; i++) {
            uploadPromises.push(uploadNext());
        }

        // Wait for all workers to complete
        await Promise.all(uploadPromises);
    }

    async function uploadPart(partNumber, partSize) {
        const start = (partNumber - 1) * partSize;
        const end = Math.min(start + partSize, selectedFile.size);
        const blob = selectedFile.slice(start, end);

        // Add progress bar for this part
        addPartProgressBar(partNumber, blob.size);

        try {
            // Get presigned URL for this part
            updatePartProgress(partNumber, 0, 'Getting upload URL...');
            
            const urlResponse = await fetch('/api/upload/multipart/urls/', {
                method: 'POST',
                headers: getAuthHeaders(),
                body: JSON.stringify({
                    upload_id: uploadState.uploadId,
                    s3_key: uploadState.s3Key,
                    part_numbers: [partNumber]
                })
            });

            if (!urlResponse.ok) {
                throw new Error(`Failed to get upload URL for part ${partNumber}`);
            }

            const urlData = await urlResponse.json();
            if (!urlData.success || !urlData.urls || urlData.urls.length === 0) {
                throw new Error(`No upload URL received for part ${partNumber}`);
            }

            const presignedUrl = urlData.urls[0].url;

            // Upload directly to S3 using XMLHttpRequest for progress tracking
            updatePartProgress(partNumber, 0, 'Uploading to S3...');
            
            const etag = await uploadWithProgress(presignedUrl, blob, (percent) => {
                updatePartProgress(partNumber, percent, `Uploading... ${formatBytes(blob.size)}`);
            });
            
            // Record uploaded part
            uploadState.parts.push({
                PartNumber: partNumber,
                ETag: etag
            });
            uploadState.uploadedParts++;
            uploadState.uploadedBytes += blob.size;
            
            // Mark as complete and remove after brief delay
            updatePartProgress(partNumber, 100, '‚úì Completed');
            setTimeout(() => removePartProgressBar(partNumber), 500);
            
        } catch (error) {
            updatePartProgress(partNumber, 0, `‚ùå Error: ${error.message}`);
            setTimeout(() => removePartProgressBar(partNumber), 2000);
            throw error;
        }

        // Update progress
        const percent = Math.round((uploadState.uploadedBytes / uploadState.totalBytes) * 100);
        const speed = calculateSpeed();
        const remaining = calculateTimeRemaining(speed);
        
        updateProgress(
            percent,
            `Uploading part ${uploadState.uploadedParts} of ${uploadState.totalParts}`,
            speed,
            remaining
        );
    }

    function uploadWithProgress(url, blob, onProgress) {
        return new Promise((resolve, reject) => {
            const xhr = new XMLHttpRequest();
            
            // Track upload progress
            xhr.upload.addEventListener('progress', (e) => {
                if (e.lengthComputable) {
                    const percent = Math.round((e.loaded / e.total) * 100);
                    onProgress(percent);
                }
            });
            
            // Handle completion
            xhr.addEventListener('load', () => {
                if (xhr.status >= 200 && xhr.status < 300) {
                    // Get ETag from response headers
                    const etag = xhr.getResponseHeader('ETag');
                    resolve(etag);
                } else {
                    reject(new Error(`Upload failed with status ${xhr.status}`));
                }
            });
            
            // Handle errors
            xhr.addEventListener('error', () => {
                reject(new Error('Network error during upload'));
            });
            
            xhr.addEventListener('abort', () => {
                reject(new Error('Upload aborted'));
            });
            
            // Open and send the request
            xhr.open('PUT', url);
            xhr.send(blob);
        });
    }

    function initializePartsGrid(numParts) {
        const container = document.getElementById('active-parts-container');
        container.innerHTML = '<div class="text-center text-sm text-gray-500 py-4">Preparing upload...</div>';
        
        // Update parts counter
        document.getElementById('parts-counter').textContent = `0 / ${numParts} completed`;
        document.getElementById('active-parts').textContent = '0';
        document.getElementById('uploaded-size').textContent = '0 MB';
        document.getElementById('avg-speed').textContent = '- MB/s';
    }

    function addPartProgressBar(partNumber, partSize) {
        const container = document.getElementById('active-parts-container');
        
        // Remove "no active uploads" message if present
        if (container.querySelector('.text-gray-500')) {
            container.innerHTML = '';
        }
        
        const partElement = document.createElement('div');
        partElement.id = `part-progress-${partNumber}`;
        partElement.className = 'bg-gray-700/50 rounded-lg p-3 border border-gray-600';
        partElement.innerHTML = `
            <div class="flex justify-between text-xs mb-2">
                <span class="text-gray-300">Part ${partNumber}</span>
                <span class="text-primary-400 font-medium" id="part-${partNumber}-percent">0%</span>
            </div>
            <div class="w-full bg-gray-700 rounded-full h-2 overflow-hidden">
                <div id="part-${partNumber}-bar" class="bg-gradient-to-r from-primary-600 to-primary-400 h-2 rounded-full transition-all duration-200" style="width: 0%"></div>
            </div>
            <div class="text-xs text-gray-500 mt-1" id="part-${partNumber}-status">Preparing...</div>
        `;
        
        container.appendChild(partElement);
    }

    function updatePartProgress(partNumber, percent, status = null) {
        const bar = document.getElementById(`part-${partNumber}-bar`);
        const percentEl = document.getElementById(`part-${partNumber}-percent`);
        const statusEl = document.getElementById(`part-${partNumber}-status`);
        
        if (bar) bar.style.width = `${percent}%`;
        if (percentEl) percentEl.textContent = `${percent}%`;
        if (status && statusEl) statusEl.textContent = status;
    }

    function removePartProgressBar(partNumber) {
        const partElement = document.getElementById(`part-progress-${partNumber}`);
        if (partElement) {
            partElement.style.opacity = '0';
            partElement.style.transform = 'scale(0.95)';
            partElement.style.transition = 'all 0.3s ease-out';
            setTimeout(() => partElement.remove(), 300);
        }
        
        // Show message if no active parts
        const container = document.getElementById('active-parts-container');
        if (container.children.length === 0) {
            container.innerHTML = '<div class="text-center text-sm text-gray-500 py-4">All parts uploaded</div>';
        }
    }

    function calculateSpeed() {
        const elapsedSeconds = (Date.now() - uploadState.startTime) / 1000;
        if (elapsedSeconds === 0) return 0;
        return uploadState.uploadedBytes / elapsedSeconds; // bytes per second
    }

    function calculateTimeRemaining(speed) {
        if (speed === 0) return Infinity;
        const remainingBytes = uploadState.totalBytes - uploadState.uploadedBytes;
        return remainingBytes / speed; // seconds
    }

    function updateProgress(percent, status, speed = null, timeRemaining = null) {
        document.getElementById('progress-percent').textContent = `${percent}%`;
        document.getElementById('progress-status').textContent = status;
        document.getElementById('progress-bar').style.width = `${percent}%`;
        
        // Update parts counter
        document.getElementById('parts-counter').textContent = `${uploadState.uploadedParts} / ${uploadState.totalParts} completed`;
        
        // Update stats
        document.getElementById('uploaded-size').textContent = formatBytes(uploadState.uploadedBytes);
        
        if (speed !== null) {
            const speedMBs = speed / (1024 * 1024);
            document.getElementById('upload-speed').textContent = `‚ö° ${formatBytes(speed)}/s`;
            document.getElementById('avg-speed').textContent = speedMBs.toFixed(2) + ' MB/s';
        }
        
        if (timeRemaining !== null && timeRemaining !== Infinity) {
            document.getElementById('time-remaining').textContent = `‚è±Ô∏è ${formatTime(timeRemaining)}`;
        }
        
        // Update active parts counter (active uploads in progress)
        const activeCount = activeUploads.length;
        document.getElementById('active-parts').textContent = activeCount;
    }

    async function showResult(data) {
        const uploadTime = ((Date.now() - uploadState.startTime) / 1000).toFixed(1);
        
        // Use the public URL from the API response
        const publicUrl = data.public_url || data.location || 'URL not available';
        
        // Check if file is video and needs audio extraction
        const isVideo = selectedFile.type.startsWith('video/');
        
        if (isVideo) {
            // Show extraction progress
            progressSection.classList.add('hidden');
            document.getElementById('extraction-section').classList.remove('hidden');
            
            try {
                // Call audio extraction endpoint
                const extractionResult = await extractAudioFromVideo(uploadState.s3Key, uploadState.jobId);
                
                // Hide extraction section
                document.getElementById('extraction-section').classList.add('hidden');
                
                // Show result with both URLs
                document.getElementById('result-job-id').textContent = uploadState.jobId;
                document.getElementById('result-url').textContent = publicUrl;
                document.getElementById('result-url').href = publicUrl;
                document.getElementById('result-file-type').textContent = 'Video (with extracted audio)';
                document.getElementById('result-upload-time').textContent = `${uploadTime} seconds`;
                
                // Show extracted audio URL
                document.getElementById('audio-url-section').classList.remove('hidden');
                document.getElementById('result-audio-url').textContent = extractionResult.extracted_audio_url;
                document.getElementById('result-audio-url').href = extractionResult.extracted_audio_url;
                
                // Show extraction time
                document.getElementById('extraction-time-row').classList.remove('hidden');
                document.getElementById('result-extraction-time').textContent = `${extractionResult.extraction_time} seconds`;
                
                resultSection.classList.remove('hidden');
                showToast('Stage 1 complete! Video uploaded and audio extracted.', 'success');
                
            } catch (extractionError) {
                // Hide extraction section
                document.getElementById('extraction-section').classList.add('hidden');
                
                // Show partial result (upload succeeded but extraction failed)
                document.getElementById('result-job-id').textContent = uploadState.jobId;
                document.getElementById('result-url').textContent = publicUrl;
                document.getElementById('result-url').href = publicUrl;
                document.getElementById('result-file-type').textContent = 'Video (audio extraction failed)';
                document.getElementById('result-upload-time').textContent = `${uploadTime} seconds`;
                
                resultSection.classList.remove('hidden');
                showToast(`Upload succeeded but audio extraction failed: ${extractionError.message}`, 'error');
            }
        } else {
            // Audio file - no extraction needed
            document.getElementById('result-job-id').textContent = uploadState.jobId;
            document.getElementById('result-url').textContent = publicUrl;
            document.getElementById('result-url').href = publicUrl;
            document.getElementById('result-file-type').textContent = 'Audio (no extraction needed)';
            document.getElementById('result-upload-time').textContent = `${uploadTime} seconds`;
            
            // For audio files, the original URL IS the audio URL
            document.getElementById('audio-url-section').classList.remove('hidden');
            document.getElementById('result-audio-url').textContent = publicUrl;
            document.getElementById('result-audio-url').href = publicUrl;
            
            progressSection.classList.add('hidden');
            resultSection.classList.remove('hidden');
            
            showToast('Stage 1 complete! Audio file uploaded.', 'success');
        }
    }
    
    async function extractAudioFromVideo(s3Key, jobId) {
        // Update extraction UI
        document.getElementById('extraction-status').textContent = 'Downloading video from S3...';
        document.getElementById('extraction-progress-bar').style.width = '20%';
        
        const response = await fetch('/api/upload/extract-audio/', {
            method: 'POST',
            headers: getAuthHeaders(),
            body: JSON.stringify({
                s3_key: s3Key,
                job_id: jobId
            })
        });
        
        // Update progress
        document.getElementById('extraction-status').textContent = 'Extracting audio using ffmpeg...';
        document.getElementById('extraction-progress-bar').style.width = '60%';
        
        const result = await response.json();
        
        if (!result.success) {
            throw new Error(result.error || 'Audio extraction failed');
        }
        
        // Complete
        document.getElementById('extraction-status').textContent = 'Audio extraction complete!';
        document.getElementById('extraction-progress-bar').style.width = '100%';
        
        return result;
    }

    function showError(message) {
        document.getElementById('error-message').textContent = message;
        progressSection.classList.add('hidden');
        document.getElementById('extraction-section').classList.add('hidden');
        errorSection.classList.remove('hidden');
        showToast(message, 'error');
    }

    function formatBytes(bytes) {
        if (bytes === 0) return '0 Bytes';
        const k = 1024;
        const sizes = ['Bytes', 'KB', 'MB', 'GB'];
        const i = Math.floor(Math.log(bytes) / Math.log(k));
        return Math.round(bytes / Math.pow(k, i) * 100) / 100 + ' ' + sizes[i];
    }

    function formatTime(seconds) {
        if (seconds < 60) return `${Math.round(seconds)}s`;
        const minutes = Math.floor(seconds / 60);
        const secs = Math.round(seconds % 60);
        return `${minutes}m ${secs}s`;
    }
</script>
{% endblock %}
